# ?? ORDERSERVICE - TÀI LI?U H??NG D?N

## ?? T?NG QUAN

`OrderService` là l?p x? lý toàn b? nghi?p v? liên quan ??n ??n hàng (Order) trong h? th?ng qu?n lý quán cà phê, s? d?ng **EF Core** và **LINQ**.

---

## ?? CÁC METHODS CHÍNH

### 1?? **GetActiveOrderByTable(tableId)**
```csharp
Order? GetActiveOrderByTable(int tableId)
```
**Ch?c n?ng:** L?y order ?ang ho?t ??ng (ch?a thanh toán) c?a bàn

**LINQ Query:**
```csharp
return _context.Orders
    .Include(o => o.OrderDetails)
        .ThenInclude(od => od.Product)
    .Include(o => o.Table)
    .Include(o => o.Staff)
    .Where(o => o.TableId == tableId)
    .OrderByDescending(o => o.CreatedAt)
    .FirstOrDefault();
```

**S? d?ng:**
- `Include()` - Eager loading ?? t?i c? OrderDetails
- `ThenInclude()` - T?i thêm Product c?a m?i OrderDetail
- `Where()` - L?c theo TableId
- `OrderByDescending()` - S?p x?p theo th?i gian t?o m?i nh?t
- `FirstOrDefault()` - L?y order ??u tiên ho?c null

---

### 2?? **AddItem(orderId, productId, quantity, note)**
```csharp
void AddItem(int orderId, int productId, int quantity, string? note = null)
```
**Ch?c n?ng:** 
- Thêm món vào order
- N?u món ?ã có ? C?ng d?n s? l??ng + c?p nh?t giá m?i
- N?u món m?i ? T?o OrderDetail m?i
- **T? ??ng tr? t?n kho** (Generic material)

**Logic:**
```csharp
// 1. Ki?m tra món ?ã có ch?a
var existingDetail = order.OrderDetails
    .FirstOrDefault(od => od.ProductId == productId);

if (existingDetail != null)
{
    // Món ?ã có ? C?ng s? l??ng
    existingDetail.Quantity += quantity;
    existingDetail.UnitPrice = product.Price; // C?p nh?t giá m?i
}
else
{
    // Món m?i ? Thêm vào
    var newDetail = new OrderDetail { ... };
    _context.OrderDetails.Add(newDetail);
}

// 2. Tr? t?n kho
UpdateInventory(productId, quantity);
```

**C?nh báo t?n kho:**
- N?u `Quantity < 0` ? Throw exception ??
- N?u `Quantity < ReorderLevel` ? Console warning ??

---

### 3?? **UpdateItem(detailId, quantity, note)**
```csharp
void UpdateItem(int detailId, int quantity, string? note = null)
```
**Ch?c n?ng:** C?p nh?t s? l??ng và ghi chú c?a món

**Code:**
```csharp
var detail = _context.OrderDetails.Find(detailId);
detail.Quantity = quantity;
if (note != null)
    detail.Note = note;
_context.SaveChanges();
```

---

### 4?? **RemoveItem(detailId)**
```csharp
void RemoveItem(int detailId)
```
**Ch?c n?ng:** Xóa món kh?i order

**Code:**
```csharp
var detail = _context.OrderDetails.Find(detailId);
_context.OrderDetails.Remove(detail);
_context.SaveChanges();
```

---

### 5?? **RecalcOrderTotals(orderId, discountPercent, vatPercent)**
```csharp
void RecalcOrderTotals(int orderId, decimal discountPercent, decimal vatPercent)
```
**Ch?c n?ng:** Tính l?i t?ng ti?n c?a order

**Công th?c:**
```
SubTotal = ?(Quantity × UnitPrice)
DiscountAmount = SubTotal × (discountPercent / 100)
AfterDiscount = SubTotal - DiscountAmount
VATAmount = AfterDiscount × (vatPercent / 100)
TotalAmount = AfterDiscount + VATAmount
```

**LINQ:**
```csharp
decimal subTotal = order.OrderDetails
    .Sum(od => od.Quantity * od.UnitPrice);
```

**Ví d?:**
```
SubTotal      = 80,000 ?
Discount 10%  = -8,000 ?
AfterDiscount = 72,000 ?
VAT 10%       = +7,200 ?
TotalAmount   = 79,200 ?
```

---

### 6?? **MoveTable(orderId, toTableId)**
```csharp
void MoveTable(int orderId, int toTableId)
```
**Ch?c n?ng:** Chuy?n order sang bàn khác (ch? khi bàn ?ích ?ang Free)

**Logic:**
```csharp
// 1. Ki?m tra bàn ?ích có tr?ng không
if (toTable.Status != "Free")
    throw new InvalidOperationException("Bàn không tr?ng!");

// 2. C?p nh?t order sang bàn m?i
order.TableId = toTableId;

// 3. C?p nh?t tr?ng thái bàn
fromTable.Status = "Free";
toTable.Status = "Serving";
```

---

### 7?? **MergeTables(fromOrderId, toOrderId)**
```csharp
void MergeTables(int fromOrderId, int toOrderId)
```
**Ch?c n?ng:** G?p 2 order l?i v?i nhau (chuy?n bàn + g?p món)

**Logic:**
```csharp
// 1. Duy?t qua t?ng món c?a fromOrder
foreach (var fromDetail in fromOrder.OrderDetails)
{
    // Ki?m tra món ?ã có trong toOrder ch?a
    var existingDetail = toOrder.OrderDetails
        .FirstOrDefault(od => od.ProductId == fromDetail.ProductId);

    if (existingDetail != null)
    {
        // C?ng d?n s? l??ng
        existingDetail.Quantity += fromDetail.Quantity;
    }
    else
    {
        // Thêm món m?i
        toOrder.OrderDetails.Add(new OrderDetail { ... });
    }
}

// 2. Xóa fromOrder
_context.Orders.Remove(fromOrder);

// 3. C?p nh?t bàn c? v? Free
fromTable.Status = "Free";

// 4. Tính l?i t?ng ti?n
RecalcOrderTotals(toOrderId, toOrder.Discount, toOrder.VAT);
```

---

## ?? UNIT TESTS

### **Danh Sách Tests (12 tests - 100% passed)**

| Test | Mô t? |
|------|-------|
| `AddItem_NewProduct_ShouldAddToOrder` | Thêm món m?i vào order |
| `AddItem_ExistingProduct_ShouldIncreaseQuantity` | Thêm món ?ã có ? C?ng s? l??ng |
| `AddItem_InsufficientInventory_ShouldThrowException` | Thêm món khi h?t t?n kho ? L?i |
| `RecalcOrderTotals_ShouldCalculateCorrectly` | Tính t?ng ti?n ?úng công th?c |
| `RecalcOrderTotals_NoDiscount_NoVAT` | Tính t?ng ti?n không gi?m giá |
| `MergeTables_ShouldCombineOrders` | G?p 2 order, c?ng d?n s? l??ng |
| `MergeTables_ShouldRecalculateTotal` | G?p order ? Tính l?i t?ng |
| `MoveTable_ShouldUpdateTableStatus` | Chuy?n bàn ? C?p nh?t tr?ng thái |
| `MoveTable_ToOccupiedTable_ShouldThrowException` | Chuy?n sang bàn ?ang dùng ? L?i |
| `UpdateItem_ShouldChangeQuantityAndNote` | C?p nh?t s? l??ng và ghi chú |
| `RemoveItem_ShouldDeleteFromOrder` | Xóa món kh?i order |

---

## ?? CÁC QUERY LINQ TIÊU BI?U

### **1. L?y order v?i t?t c? relations**
```csharp
var order = _context.Orders
    .Include(o => o.OrderDetails)
        .ThenInclude(od => od.Product)
    .Include(o => o.Table)
    .Include(o => o.Staff)
    .FirstOrDefault(o => o.Id == orderId);
```

### **2. Tính t?ng SubTotal c?a order**
```csharp
decimal subTotal = order.OrderDetails
    .Sum(od => od.Quantity * od.UnitPrice);
```

### **3. L?y món ?ã có trong order**
```csharp
var existingDetail = order.OrderDetails
    .FirstOrDefault(od => od.ProductId == productId);
```

### **4. L?y t?t c? nguyên li?u d??i m?c t?n kho**
```csharp
var lowStock = _context.Inventories
    .Where(i => i.Quantity < i.ReorderLevel)
    .ToList();
```

### **5. L?y order details v?i Product và Category**
```csharp
var details = _context.OrderDetails
    .Include(od => od.Product)
        .ThenInclude(p => p.Category)
    .Where(od => od.OrderId == orderId)
    .OrderBy(od => od.Id)
    .ToList();
```

---

## ?? S? ?? LU?NG X? LÝ

### **AddItem Flow:**
```
???????????????????????????????????????
?   AddItem(orderId, productId, qty)  ?
???????????????????????????????????????
              ?
              ?
       ????????????????
       ? Load Order   ?
       ????????????????
              ?
              ?
     ??????????????????????
     ? Product ?ã có?     ?
     ??????????????????????
           ? Yes      ? No
           ?          ?
    ????????????  ????????????
    ? C?ng qty ?  ? Thêm m?i ?
    ????????????  ????????????
           ?            ?
           ??????????????
                ?
       ??????????????????
       ? Tr? t?n kho    ?
       ??????????????????
                ?
                ?
          ????????????
          ? SaveChanges?
          ????????????
```

### **MergeTables Flow:**
```
??????????????????????????????????????
? MergeTables(fromOrderId, toOrderId)?
??????????????????????????????????????
             ?
             ?
   ???????????????????????
   ? Load 2 Orders       ?
   ???????????????????????
              ?
              ?
   ????????????????????????????????
   ? Duy?t t?ng món fromOrder     ?
   ????????????????????????????????
          ?
          ?
   ????????????????????
   ? Món ?ã có?       ?
   ????????????????????
       ? Yes      ? No
       ?          ?
 ???????????  ???????????
 ? C?ng qty?  ? Add new ?
 ???????????  ???????????
      ?            ?
      ??????????????
            ?
   ??????????????????
   ? Delete fromOrder?
   ??????????????????
            ?
            ?
   ????????????????????
   ? Update fromTable ?
   ? Status = Free    ?
   ????????????????????
            ?
            ?
   ??????????????????????
   ? RecalcOrderTotals  ?
   ??????????????????????
```

---

## ?? CH?Y UNIT TESTS

### **Ch?y t?t c? tests:**
```bash
dotnet test QuanLiCafe.Tests/QuanLiCafe.Tests.csproj
```

### **Ch?y v?i logging chi ti?t:**
```bash
dotnet test QuanLiCafe.Tests/QuanLiCafe.Tests.csproj --logger "console;verbosity=detailed"
```

### **Ch?y test c? th?:**
```bash
dotnet test --filter "FullyQualifiedName~AddItem_NewProduct"
```

### **K?t qu? mong ??i:**
```
Test Run Successful.
Total tests: 12
     Passed: 12
 Total time: 5.4s
```

---

## ?? VÍ D? S? D?NG

### **1. T?o order và thêm món:**
```csharp
// Inject service
var orderService = new OrderService(context);

// T?o order m?i cho bàn 1
var order = orderService.CreateOrder(tableId: 1, staffId: 1);

// Thêm món
orderService.AddItem(order.Id, productId: 1, quantity: 2, note: "Ít ???ng");
orderService.AddItem(order.Id, productId: 2, quantity: 1);

// Tính t?ng ti?n
orderService.RecalcOrderTotals(order.Id, discountPercent: 10, vatPercent: 10);
```

### **2. G?p 2 bàn:**
```csharp
// Bàn 1 có order v?i ID = 5
// Bàn 2 có order v?i ID = 7

// G?p bàn 1 vào bàn 2
orderService.MergeTables(fromOrderId: 5, toOrderId: 7);

// Bàn 1 t? ??ng v? Free
// Bàn 2 có t?t c? món c?a 2 bàn (c?ng d?n n?u trùng)
```

### **3. Chuy?n bàn:**
```csharp
// Chuy?n order t? bàn 1 sang bàn 3
orderService.MoveTable(orderId: 5, toTableId: 3);

// Bàn 1 ? Free
// Bàn 3 ? Serving
```

---

## ?? DEPENDENCY INJECTION (DI)

### **??ng ký trong Program.cs:**
```csharp
builder.Services.AddDbContext<CafeContext>(options =>
    options.UseSqlServer(connectionString));

builder.Services.AddScoped<IOrderService, OrderService>();
```

### **S? d?ng trong Controller/Form:**
```csharp
public class OrderController
{
    private readonly IOrderService _orderService;

    public OrderController(IOrderService orderService)
    {
        _orderService = orderService;
    }

    public void PlaceOrder(int tableId, List<OrderItem> items)
    {
        var order = _orderService.CreateOrder(tableId, staffId: 1);
        
        foreach (var item in items)
        {
            _orderService.AddItem(order.Id, item.ProductId, item.Quantity);
        }
        
        _orderService.RecalcOrderTotals(order.Id, 0, 10);
    }
}
```

---

## ? HOÀN T?T!

**OrderService ?ã ???c implement ??y ?? v?i:**
- ? 9 methods nghi?p v? chính
- ? LINQ queries t?i ?u
- ? 12 unit tests (100% passed)
- ? T? ??ng qu?n lý t?n kho
- ? Exception handling ??y ??
- ? In-Memory database cho tests
