# ?? H? TH?NG BÁO CÁO & B?O M?T - H??NG D?N ??Y ??

## ? ?Ã HOÀN THÀNH

### 1?? **AuthService** - Xác Th?c & Phân Quy?n

**Files:**
- `QuanLiCafe/Services/IAuthService.cs`
- `QuanLiCafe/Services/AuthService.cs`

**Methods:**
```csharp
User? Login(string username, string password)          // ??ng nh?p v?i BCrypt
void Register(string username, string password, string role) // ??ng ký (Admin only)
void ChangePassword(int userId, string oldPassword, string newPassword)
bool IsAdmin(User user)                                 // Ki?m tra quy?n Admin
bool IsStaff(User user)                                 // Ki?m tra quy?n Staff
string HashPassword(string password)                    // BCrypt hash (WorkFactor=12)
bool VerifyPassword(string password, string hash)      // BCrypt verify
```

**??c ?i?m:**
- ? Hash m?t kh?u v?i **BCrypt.Net-Next v4.0.3** (WorkFactor = 12)
- ? Phân quy?n: Admin / Staff
- ? LINQ: `FirstOrDefault` ?? tìm user

---

### 2?? **ReportService** - Báo Cáo Doanh Thu

**Files:**
- `QuanLiCafe/Services/IReportService.cs`
- `QuanLiCafe/Services/ReportService.cs`

**Methods:**
```csharp
Dictionary<DateTime, decimal> GetRevenueByDate(DateTime from, DateTime to)
Dictionary<string, decimal> GetRevenueByMonth(int year)
List<ProductSalesReport> GetTopSellingProducts(int top = 5)
List<StaffRevenueReport> GetRevenueByStaff(DateTime? from, DateTime? to)
decimal GetTotalRevenue(DateTime from, DateTime to)
int GetTotalOrders(DateTime from, DateTime to)
```

**LINQ Queries Tiêu Bi?u:**

**1. Doanh thu theo ngày:**
```csharp
return _context.Orders
    .Where(o => o.CreatedAt >= fromDate && o.CreatedAt <= toDate)
    .GroupBy(o => o.CreatedAt.Date)
    .Select(g => new
    {
        Date = g.Key,
        Revenue = g.Sum(o => o.TotalAmount)
    })
    .OrderBy(x => x.Date)
    .ToDictionary(x => x.Date, x => x.Revenue);
```

**2. Top s?n ph?m bán ch?y:**
```csharp
return _context.OrderDetails
    .Include(od => od.Product)
    .GroupBy(od => new { od.ProductId, od.Product.Name })
    .Select(g => new ProductSalesReport
    {
        ProductId = g.Key.ProductId,
        ProductName = g.Key.Name,
        TotalQuantity = g.Sum(od => od.Quantity),
        TotalRevenue = g.Sum(od => od.Quantity * od.UnitPrice),
        OrderCount = g.Select(od => od.OrderId).Distinct().Count()
    })
    .OrderByDescending(p => p.TotalQuantity)
    .Take(top)
    .ToList();
```

**3. Doanh thu theo nhân viên:**
```csharp
return _context.Orders
    .Include(o => o.Staff)
    .Where(o => o.CreatedAt >= fromDate && o.CreatedAt <= toDate)
    .GroupBy(o => new { o.StaffId, o.Staff.Username })
    .Select(g => new StaffRevenueReport
    {
        StaffId = g.Key.StaffId,
        StaffName = g.Key.Username,
        TotalOrders = g.Count(),
        TotalRevenue = g.Sum(o => o.TotalAmount),
        AverageOrderValue = g.Average(o => o.TotalAmount)
    })
    .OrderByDescending(s => s.TotalRevenue)
    .ToList();
```

---

### 3?? **FormLogin** - Giao Di?n ??ng Nh?p

**File:** `QuanLiCafe/Forms/FormLogin.cs`

**Giao di?n:**
```
???????????????????????????????????????
?      ? ??NG NH?P                   ? ? Header (xanh ??m)
???????????????????????????????????????
?                                     ?
?  ?? Tên ??ng nh?p:                  ?
?  ?????????????????????????????????  ?
?  ? admin                         ?  ?
?  ?????????????????????????????????  ?
?                                     ?
?  ?? M?t kh?u:                       ?
?  ?????????????????????????????????  ?
?  ? ••••••••                      ?  ?
?  ?????????????????????????????????  ?
?  ? Hi?n m?t kh?u                    ?
?                                     ?
?  ???????????????  ???????????????  ?
?  ? ?? ??NG NH?P ?  ?  ?? THOÁT   ?  ?
?  ???????????????  ???????????????  ?
???????????????????????????????????????
```

**Tính n?ng:**
- ? TextBox username
- ? TextBox password (UseSystemPasswordChar)
- ? CheckBox hi?n m?t kh?u
- ? Enter key = Login
- ? BCrypt verify password
- ? Set `Program.CurrentUser` sau khi login thành công

---

### 4?? **FormReport** - Báo Cáo Doanh Thu

**File:** `QuanLiCafe/Forms/FormReport.cs`

**Giao di?n:**
```
??????????????????????????????????????????????????????????????
?  ?? BÁO CÁO DOANH THU                 ?? T?ng DT: 5.5M ?  ?
?  ?? admin (Admin)                      ?? T?ng ?H: 50     ?
?  T? ngày: [01/11/2025] ??n: [04/11/2025]  [?? T?i L?i]   ?
??????????????????????????????????????????????????????????????
? [?? Doanh Thu Theo Ngày] [?? Top S?n Ph?m] [?? Theo NV] ?
??????????????????????????????????????????????????????????????
? TAB 1: DOANH THU THEO NGÀY                                 ?
? ????????????????????????????????????????????????????????   ?
? ? STT ? Ngày       ? Doanh Thu ? Doanh Thu (Format) ?   ?
? ????????????????????????????????????????????????????????   ?
? ?  1  ? 01/11/2025 ?  150,000  ? 150,000 ?          ?   ?
? ?  2  ? 02/11/2025 ?  200,000  ? 200,000 ?          ?   ?
? ????????????????????????????????????????????????????????   ?
?                                                            ?
? TAB 2: TOP 5 S?N PH?M BÁN CH?Y                            ?
? ????????????????????????????????????????????????????????   ?
? ? STT ? Tên SP      ? SL Bán ? Doanh Thu ? S? ??n  ?   ?
? ????????????????????????????????????????????????????????   ?
? ?  1  ? Cà phê ?en  ?   50   ? 1,250,000 ?   25    ?   ?
? ?  2  ? Cà phê s?a  ?   40   ? 1,200,000 ?   20    ?   ?
? ????????????????????????????????????????????????????????   ?
?                                                            ?
? TAB 3: DOANH THU THEO NHÂN VIÊN                           ?
? ????????????????????????????????????????????????????????   ?
? ? STT ? NV      ? S? ??n ? T?ng DT   ? TB/??n      ?   ?
? ????????????????????????????????????????????????????????   ?
? ?  1  ? admin   ?   30   ? 3,500,000 ? 116,667     ?   ?
? ?  2  ? staff01 ?   20   ? 2,000,000 ? 100,000     ?   ?
? ????????????????????????????????????????????????????????   ?
??????????????????????????????????????????????????????????????
```

**Tính n?ng:**
- ? 3 TabPages cho 3 lo?i báo cáo
- ? DateTimePicker ch?n kho?ng th?i gian
- ? Summary labels: T?ng DT, T?ng ?H
- ? DataGridView v?i styling ??p
- ? T? ??ng tính toán t? LINQ queries

---

### 5?? **Phân Quy?n (FormMain)**

**File:** `QuanLiCafe/Forms/FormMain.cs` (Updated)

**Thay ??i:**

**1. Hi?n th? user info:**
```csharp
lblUserInfo = new Label
{
    Text = $"?? {_currentUser.Username} ({_currentUser.Role})",
    // ...
};
```

**2. ?n button theo quy?n:**
```csharp
btnReport = new Button
{
    // ...
    Visible = _authService.IsAdmin(_currentUser) // ? Ch? Admin th?y
};

btnInventory = new Button
{
    // ...
    Visible = _authService.IsAdmin(_currentUser) // ? Ch? Admin th?y
};
```

**3. Double-check khi click:**
```csharp
private void BtnInventory_Click(object? sender, EventArgs e)
{
    if (!_authService.IsAdmin(_currentUser))
    {
        MessageBox.Show("B?n không có quy?n!", "?? T? Ch?i",
            MessageBoxButtons.OK, MessageBoxIcon.Warning);
        return;
    }
    // ...
}
```

---

### 6?? **Seed Demo Data**

**File:** `QuanLiCafe/Helpers/DatabaseSeeder.cs`

**Ch?c n?ng:**

**1. Update passwords to BCrypt:**
```csharp
admin.PasswordHash = BCrypt.Net.BCrypt.HashPassword("admin123", workFactor: 12);
staff.PasswordHash = BCrypt.Net.BCrypt.HashPassword("staff123", workFactor: 12);
```

**2. Seed 50 random orders:**
- Random ngày trong tháng hi?n t?i (1-30)
- Random gi? (8AM - 10PM)
- Random table (1-5)
- Random staff (admin, staff01, staff02, staff03)
- Random 1-4 món m?i order
- Random discount: 0%, 5%, 10%, 15%
- VAT c? ??nh: 10%

**3. T? ??ng g?i trong Program.Main():**
```csharp
DatabaseSeeder.SeedDemoData(DbContext);
```

---

## ?? S? LI?U DEMO

### **Users (4 tài kho?n):**
| Username | Password  | Role  |
|----------|-----------|-------|
| admin    | admin123  | Admin |
| staff01  | staff123  | Staff |
| staff02  | staff123  | Staff |
| staff03  | staff123  | Staff |

### **Products (5 s?n ph?m):**
1. Cà phê ?en - 25,000?
2. Cà phê s?a - 30,000?
3. B?c x?u - 28,000?
4. Trà s?a truy?n th?ng - 35,000?
5. Trà s?a matcha - 40,000?

### **Orders (50 ??n ng?u nhiên):**
- Ngày: 01/11/2025 - 30/11/2025 (tháng hi?n t?i)
- Gi?: 08:00 - 22:00
- Discount: 0%, 5%, 10%, 15% (random)
- VAT: 10% (fixed)
- S? món/??n: 1-4 món

---

## ?? PHÂN QUY?N CHI TI?T

| Ch?c n?ng | Admin | Staff |
|-----------|-------|-------|
| **Xem s? ?? bàn** | ? | ? |
| **??t món** | ? | ? |
| **Thanh toán** | ? | ? |
| **Xem báo cáo** | ? | ? |
| **Qu?n lý kho** | ? | ? |
| **Nút "?? Báo Cáo"** | Hi?n | ?n |
| **Nút "?? Kho"** | Hi?n | ?n |

**C? ch?:**
1. **Frontend:** Button `.Visible = IsAdmin()` - ?n button v?i Staff
2. **Backend:** Double-check trong event handler - Hi?n th? MessageBox n?u unauthorized

---

## ?? H??NG D?N CH?Y

### **B??c 1: Update Database (L?n ??u tiên)**
```bash
# Xóa migration c? (n?u có)
dotnet ef migrations remove --project QuanLiCafe/QuanLiCafe.csproj

# T?o migration m?i
dotnet ef migrations add AddAuthAndReports --project QuanLiCafe/QuanLiCafe.csproj

# Update database
dotnet ef database update --project QuanLiCafe/QuanLiCafe.csproj
```

### **B??c 2: Build & Run**
```bash
dotnet build
dotnet run --project QuanLiCafe/QuanLiCafe.csproj
```

**Ho?c trong Visual Studio:**
- Press `F5` (Debug) ho?c `Ctrl+F5` (Run)

### **B??c 3: ??ng nh?p**
```
Username: admin
Password: admin123
```

**Ho?c:**
```
Username: staff01
Password: staff123
```

### **B??c 4: Test phân quy?n**

**V?i Admin:**
1. Login v?i `admin`
2. Th?y 3 nút: "?? Báo Cáo", "?? Kho", "?? T?i L?i"
3. Click "?? Báo Cáo" ? Xem ???c báo cáo
4. Click "?? Kho" ? Qu?n lý ???c kho

**V?i Staff:**
1. Login v?i `staff01`
2. Ch? th?y nút: "?? T?i L?i"
3. Không th?y nút "Báo Cáo" và "Kho"
4. Có th? ??t món và thanh toán bình th??ng

---

## ?? CHECKLIST TEST CU?I

### ? **Test Auth:**
- [ ] Login thành công v?i admin/admin123
- [ ] Login thành công v?i staff01/staff123
- [ ] Login th?t b?i v?i sai password
- [ ] Login th?t b?i v?i username không t?n t?i
- [ ] Checkbox "Hi?n m?t kh?u" ho?t ??ng
- [ ] Enter key submit form login

### ? **Test Phân Quy?n:**
- [ ] Admin th?y nút "?? Báo Cáo"
- [ ] Admin th?y nút "?? Kho"
- [ ] Staff KHÔNG th?y nút "?? Báo Cáo"
- [ ] Staff KHÔNG th?y nút "?? Kho"
- [ ] Admin vào ???c FormReport
- [ ] Admin vào ???c FormInventory
- [ ] Staff vào ???c FormOrder (??t món)

### ? **Test Báo Cáo:**
- [ ] Tab "Doanh Thu Theo Ngày" hi?n th? ?úng
- [ ] Tab "Top S?n Ph?m" hi?n th? ?úng
- [ ] Tab "Doanh Thu Theo NV" hi?n th? ?úng
- [ ] DateTimePicker ch?n kho?ng th?i gian
- [ ] Nút "?? T?i L?i" refresh d? li?u
- [ ] Summary labels (T?ng DT, T?ng ?H) ?úng
- [ ] DataGridView có d? li?u (n?u ?ã seed 50 orders)

### ? **Test Seed Data:**
- [ ] Có 50 orders trong tháng hi?n t?i
- [ ] M?i order có 1-4 món
- [ ] Ngày random t? 1-30
- [ ] Gi? random t? 8-22
- [ ] Discount random: 0%, 5%, 10%, 15%
- [ ] VAT c? ??nh: 10%
- [ ] TotalAmount tính ?úng công th?c

### ? **Test BCrypt:**
- [ ] Password ???c hash v?i BCrypt (WorkFactor=12)
- [ ] Verify password thành công v?i ?úng password
- [ ] Verify password th?t b?i v?i sai password
- [ ] Hash khác nhau m?i l?n (bcrypt salt)

---

## ?? B?O M?T

### **BCrypt Configuration:**
- **WorkFactor:** 12 (recommended)
- **Salt:** Auto-generated per password
- **Hash Length:** 60 characters
- **Algorithm:** Blowfish-based

### **Best Practices:**
? Không bao gi? l?u plain text password  
? Hash ngay khi register/change password  
? Verify hash khi login  
? WorkFactor >= 12 (trade-off security vs speed)  
? Phân quy?n ? c? frontend (UI) và backend (logic)

---

## ?? PACKAGES ?Ã CÀI

```xml
<PackageReference Include="BCrypt.Net-Next" Version="4.0.3" />
<PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="8.0.11" />
<PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.11" />
<PackageReference Include="Microsoft.Extensions.Configuration.Json" Version="8.0.1" />
```

---

## ?? HOÀN T?T

**?ã tri?n khai ??y ??:**
- ? FormLogin v?i BCrypt authentication
- ? FormReport v?i 3 lo?i báo cáo (LINQ)
- ? AuthService v?i hash/verify password
- ? ReportService v?i GroupBy/Select/OrderBy
- ? Phân quy?n Admin/Staff
- ? Seed 50 orders ng?u nhiên
- ? Update FormMain v?i user info
- ? ?n/khóa ch?c n?ng theo role

**Ready for Production!** ??
