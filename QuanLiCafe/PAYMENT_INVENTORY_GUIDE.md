# ?? TÀI LI?U HOÀN CH?NH - PAYMENT & INVENTORY

## ? ?Ã B? SUNG

### 1?? **PaymentService** - Thanh Toán & Xu?t Hóa ??n

#### **Interface: IPaymentService**
```csharp
public interface IPaymentService
{
    void ProcessPayment(int orderId, decimal discountPercent, decimal vatPercent);
    string ExportInvoiceToPDF(int orderId, string outputPath);
    string ExportInvoiceToExcel(int orderId, string outputPath);
}
```

#### **Implementation: PaymentService**
- ? `ProcessPayment()`: Tính t?ng b?ng OrderService.RecalcOrderTotals() + C?p nh?t Tables.Status = "Closed"
- ? `ExportInvoiceToPDF()`: Xu?t PDF b?ng iTextSharp.LGPLv2.Core
- ? `ExportInvoiceToExcel()`: Xu?t Excel b?ng EPPlus

---

### 2?? **InventoryService** - Qu?n Lý Kho

#### **Interface: IInventoryService**
```csharp
public interface IInventoryService
{
    List<Inventory> GetAllInventories();
    Inventory? GetInventoryById(int id);
    void ImportStock(int materialId, decimal quantity, decimal cost);
    List<ImportHistory> GetImportHistory(int materialId);
    List<Inventory> GetLowStockItems();
    void AddInventory(string materialName, string unit, decimal quantity, decimal reorderLevel);
    void UpdateInventory(int id, string materialName, string unit, decimal reorderLevel);
}
```

#### **LINQ Queries Tiêu Bi?u**

**1. L?y t?t c? nguyên li?u:**
```csharp
return _context.Inventories
    .OrderBy(i => i.MaterialName)
    .ToList();
```

**2. Nh?p kho (ImportStock):**
```csharp
var inventory = _context.Inventories.Find(materialId);
inventory.Quantity += quantity; // C?ng s? l??ng

var importHistory = new ImportHistory
{
    MaterialId = materialId,
    Quantity = quantity,
    Cost = cost,
    ImportedAt = DateTime.Now
};
_context.ImportHistories.Add(importHistory);
_context.SaveChanges();
```

**3. L?y nguyên li?u d??i m?c t?n kho:**
```csharp
return _context.Inventories
    .Where(i => i.Quantity < i.ReorderLevel)
    .OrderBy(i => i.Quantity)
    .ToList();
```

**4. L?y l?ch s? nh?p kho:**
```csharp
return _context.ImportHistories
    .Include(ih => ih.Material)
    .Where(ih => ih.MaterialId == materialId)
    .OrderByDescending(ih => ih.ImportedAt)
    .ToList();
```

---

### 3?? **FormOrder** - Tích H?p Thanh Toán

#### **Thay ??i:**
1. Thêm `IPaymentService _paymentService`
2. Constructor kh?i t?o services:
```csharp
var orderService = new OrderService(_context);
_paymentService = new PaymentService(_context, orderService);
```

3. `BtnPayment_Click()` ???c c?p nh?t:
```csharp
// L?u OrderDetails vào DB
// ...

// ? X? lý thanh toán
_paymentService.ProcessPayment(_currentOrder.Id, discountPercent, vatPercent);

// ? H?i xu?t hóa ??n
var exportResult = MessageBox.Show(
    "Yes = PDF | No = Excel | Cancel = Không xu?t",
    "?? Xu?t Hóa ??n",
    MessageBoxButtons.YesNoCancel);

if (exportResult == DialogResult.Yes)
{
    outputFile = _paymentService.ExportInvoiceToPDF(_currentOrder.Id, folderPath);
}
else if (exportResult == DialogResult.No)
{
    outputFile = _paymentService.ExportInvoiceToExcel(_currentOrder.Id, folderPath);
}

// M? file t? ??ng
System.Diagnostics.Process.Start(outputFile);
```

---

### 4?? **FormInventory** - Qu?n Lý Kho

#### **Giao Di?n:**
```
???????????????????????????????????????????????????????
?  ?? QU?N LÝ KHO                                     ? ? Header
???????????????????????????????????????????????????????
? [? Thêm NVL] [?? Nh?p Kho] [?? S?a] [?? T?i L?i] ?
? [?? T?n Kho Th?p] [?? L?ch S?]                     ? ? Toolbar
???????????????????????????????????????????????????????
? ID ? Tên NVL     ? ?V  ? SL   ? Min  ? Tr?ng thái?
????????????????????????????????????????????????????
? 1  ? Cà phê b?t  ? kg  ? 50   ? 10   ? ? ??    ?
? 2  ? S?a t??i    ? lít ? 5    ? 20   ? ?? Th?p  ?
? 3  ? ???ng       ? kg  ? 30   ? 15   ? ? ??    ?
???????????????????????????????????????????????????????
```

#### **Tính N?ng:**
- ? DataGridView hi?n th? t?t c? nguyên li?u
- ? Tr?ng thái t? ??ng: ? ?? / ?? Th?p (d?a trên ReorderLevel)
- ? Nút "Nh?p Kho" ? M? dialog nh?p
- ? Nút "T?n Kho Th?p" ? Filter ch? hi?n th? NVL d??i m?c t?i thi?u
- ? Nút "L?ch S?" ? Xem l?ch s? nh?p kho

---

### 5?? **FormImportStock** - Dialog Nh?p Kho

#### **Giao Di?n:**
```
???????????????????????????????????????
? ?? NH?P KHO                         ?
?                                     ?
? Nguyên li?u: Cà phê b?t            ?
? T?n kho hi?n t?i: 50.00 kg         ?
?                                     ?
? S? L??ng Nh?p (kg): [    10.00   ] ?
? Giá Nh?p (?):       [ 200,000     ] ?
?                                     ?
?              [? Nh?p Kho] [? H?y] ?
???????????????????????????????????????
```

#### **X? Lý:**
```csharp
_inventoryService.ImportStock(
    _inventory.Id, 
    nudQuantity.Value,  // S? l??ng nh?p
    nudCost.Value       // Giá nh?p
);

// Service s?:
// 1. C?ng Inventory.Quantity
// 2. Ghi ImportHistory
// 3. SaveChanges()
```

---

### 6?? **FormImportHistory** - L?ch S? Nh?p Kho

#### **Giao Di?n:**
```
????????????????????????????????????????????????????????
? ?? L?CH S? NH?P KHO - Cà phê b?t                    ?
????????????????????????????????????????????????????????
? ID ? Th?i Gian          ? SL   ? ?V ? Giá   ? T?ng?
?????????????????????????????????????????????????????
? 5  ?04/11/2025 14:30:00?10.00 ? kg ?200,000?2M  ?
? 4  ?03/11/2025 09:15:00?20.00 ? kg ?195,000?3.9M?
? 3  ?01/11/2025 16:45:00?15.00 ? kg ?198,000?2.97M?
????????????????????????????????????????????????????????
```

---

## ?? S? ?? LU?NG X? LÝ

### **Lu?ng Thanh Toán:**
```
?????????????????????????????????
? User Click "?? THANH TOÁN"   ?
?????????????????????????????????
              ?
              ?
    ???????????????????????
    ? L?u OrderDetails DB ?
    ???????????????????????
               ?
               ?
    ????????????????????????????
    ? PaymentService           ?
    ? .ProcessPayment()        ?
    ? - RecalcOrderTotals()    ?
    ? - Table.Status = Closed  ?
    ????????????????????????????
               ?
               ?
    ???????????????????????????
    ? H?i Xu?t Hóa ??n?       ?
    ? Yes=PDF / No=Excel      ?
    ???????????????????????????
        ? Yes         ? No
        ?             ?
   ???????????  ???????????
   ? PDF     ?  ? Excel   ?
   ???????????  ???????????
        ?            ?
        ??????????????
              ?
    ??????????????????
    ? M? File T? ??ng?
    ??????????????????
```

### **Lu?ng Nh?p Kho:**
```
????????????????????????????
? User Click "?? Nh?p Kho"?
????????????????????????????
            ?
            ?
????????????????????????????
? M? FormImportStock       ?
? - Nh?p Quantity + Cost   ?
????????????????????????????
            ?
            ?
??????????????????????????????
? InventoryService           ?
? .ImportStock()             ?
? - C?ng Inventory.Quantity ?
? - Add ImportHistory       ?
??????????????????????????????
            ?
            ?
??????????????????????????
? Refresh DataGridView   ?
??????????????????????????
```

---

## ?? **M?U HÓA ??N PDF**

```
???????????????????????????????????????
        HÓA ??N THANH TOÁN
???????????????????????????????????????
           QUÁN CÀ PHÊ ABC
   ??a ch?: 123 Nguy?n V?n Linh, TP.HCM
          ?T: 0123.456.789

Mã hóa ??n: #15
Bàn: Bàn 5
Nhân viên: admin
Th?i gian: 04/11/2025 23:45:30

???????????????????????????????????????
STT ? Tên món     ? SL? ??n giá ? Thành ti?n
?????????????????????????????????????????????
 1  ? Cà phê ?en  ? 2 ? 25,000 ?? 50,000 ?
 2  ? Cà phê s?a  ? 1 ? 30,000 ?? 30,000 ?
???????????????????????????????????????

                      T?m tính: 80,000 ?
                  Gi?m giá (10%): -8,000 ?
                       VAT (10%): +7,200 ?
                  ???????????????????????
                  T?NG C?NG: 79,200 ?

        C?m ?n quý khách! H?n g?p l?i!
```

---

## ?? **M?U HÓA ??N EXCEL**

| A | B | C | D | E |
|---|---|---|---|---|
| **HÓA ??N THANH TOÁN** (merged A1:E1, center, 18pt) |
| **QUÁN CÀ PHÊ ABC** (merged A2:E2, center) |
| ??a ch?: ... (merged A3:E3, center) |
| | | | | |
| Mã hóa ??n: | #15 | | | |
| Bàn: | Bàn 5 | | | |
| Nhân viên: | admin | | | |
| Th?i gian: | 04/11/2025 23:45:30 | | | |
| | | | | |
| **STT** | **Tên món** | **SL** | **??n giá** | **Thành ti?n** |
| 1 | Cà phê ?en | 2 | 25,000 ? | 50,000 ? |
| 2 | Cà phê s?a | 1 | 30,000 ? | 30,000 ? |
| | | | | |
| | | | T?m tính: | 80,000 ? |
| | | | Gi?m giá (10%): | -8,000 ? |
| | | | VAT (10%): | +7,200 ? |
| | | | **T?NG C?NG:** | **79,200 ?** |

---

## ?? **PACKAGES ?Ã CÀI ??T**

```xml
<PackageReference Include="iTextSharp.LGPLv2.Core" Version="3.4.22" />
<PackageReference Include="EPPlus" Version="7.5.2" />
```

**iTextSharp.LGPLv2.Core:** 
- Xu?t PDF
- H? tr? ti?ng Vi?t qua BaseFont v?i arial.ttf
- T?o b?ng, paragraph, styling

**EPPlus:**
- Xu?t Excel (.xlsx)
- License: NonCommercial
- Styling: Fill, Border, Font, Number Format

---

## ?? **CH?Y DEMO**

### **1. Thanh Toán & Xu?t Hóa ??n:**
```csharp
// 1. M? FormMain
// 2. Click vào bàn b?t k?
// 3. Thêm món
// 4. Click "?? THANH TOÁN"
// 5. Ch?n Yes (PDF) ho?c No (Excel)
// 6. Ch?n th? m?c l?u
// 7. File t? ??ng m?
```

### **2. Qu?n Lý Kho:**
```csharp
// 1. M? FormMain
// 2. Click "?? Kho" trên header
// 3. Thêm nguyên li?u m?i (n?u c?n)
// 4. Click "?? Nh?p Kho"
// 5. Nh?p s? l??ng + giá
// 6. Click "? Nh?p Kho"
// 7. Xem "?? L?ch S?" ?? check
```

---

## ? HOÀN T?T

**?ã b? sung ??y ??:**
- ? PaymentService v?i PDF + Excel export
- ? InventoryService v?i LINQ queries
- ? FormInventory + 3 dialog forms
- ? Tích h?p vào FormOrder và FormMain
- ? T?t c? thao tác dùng EF Core + LINQ (không SQL th? công)
- ? Build successful

**Ready for Production!** ??
