@echo off
chcp 65001 > nul
cls
echo ??????????????????????????????????????????????????????????????
echo ?         QUAN LY CAFE - DATABASE SETUP                     ?
echo ??????????????????????????????????????????????????????????????
echo.

REM Check if running in QuanLiCafe directory
if not exist "QuanLiCafe.csproj" (
    echo [ERROR] Please run this script in QuanLiCafe directory!
    echo Current directory: %CD%
    pause
    exit /b 1
)

echo [Step 1/5] Checking appsettings.json...
if exist "appsettings.json" (
    echo [INFO] appsettings.json already exists. Skipping copy.
) else (
    echo [INFO] Creating appsettings.json from template...
    copy appsettings.example.json appsettings.json > nul
    echo [SUCCESS] appsettings.json created!
)
echo.

echo ??????????????????????????????????????????????????????????????
echo ?  IMPORTANT: Update Connection String                      ?
echo ??????????????????????????????????????????????????????????????
echo.
echo Please open appsettings.json and update:
echo   "Server=YOUR_HOSTNAME\\SQLEXPRESS"
echo.
echo Common options:
echo   1. localhost\SQLEXPRESS (SQL Server Express)
echo   2. (localdb)\MSSQLLocalDB (LocalDB)
echo   3. Your computer's hostname\SQLEXPRESS
echo.
echo To find your instance name, run: sqlcmd -L
echo.
echo Press any key when you've updated the connection string...
pause > nul
echo.

echo [Step 2/5] Checking SQL Server connection...
dotnet ef database drop --force > nul 2>&1
if errorlevel 1 (
    echo [WARNING] Cannot connect to database. Please check:
    echo   - SQL Server is running
    echo   - Connection string is correct
    echo   - Instance name is correct
    echo.
    echo Continue anyway? (Y/N)
    set /p continue=
    if /i not "%continue%"=="Y" (
        exit /b 1
    )
)
echo [SUCCESS] Connection OK!
echo.

echo [Step 3/5] Creating migrations...
if exist "Migrations" (
    echo [INFO] Migrations folder exists. Removing old migrations...
    rmdir /s /q Migrations
)
dotnet ef migrations add InitialCreate
if errorlevel 1 (
    echo [ERROR] Failed to create migrations!
    echo Please check:
    echo   - .NET SDK is installed
    echo   - EF Core tools are installed: dotnet tool install --global dotnet-ef
    pause
    exit /b 1
)
echo [SUCCESS] Migrations created!
echo.

echo [Step 4/5] Creating database and tables...
dotnet ef database update
if errorlevel 1 (
    echo [ERROR] Failed to create database!
    echo Please check connection string and try again.
    pause
    exit /b 1
)
echo [SUCCESS] Database created!
echo.

echo [Step 5/5] Verifying setup...
dotnet build > nul 2>&1
if errorlevel 1 (
    echo [WARNING] Build has some warnings/errors.
    echo Review and fix before running.
) else (
    echo [SUCCESS] Build completed successfully!
)
echo.

echo ??????????????????????????????????????????????????????????????
echo ?  SETUP COMPLETE!                                          ?
echo ??????????????????????????????????????????????????????????????
echo.
echo Database: QuanLiCafeDB
echo.
echo Default Login Credentials:
echo   Username: admin
echo   Password: admin123
echo.
echo   Username: staff01
echo   Password: staff123
echo.
echo To run the application:
echo   dotnet run
echo.
echo To reset database:
echo   dotnet ef database drop --force
echo   dotnet ef database update
echo.
pause
